# Поиск состязательных примеров, анализ области применимости моделей в пространстве входных признаков, определение уверенности моделей при осуществении прогноза.
## Общие сведения

Репозиторий с исходным кодом для Экспериментального Образца (ЭО) программного обеспечения, разрабатываемого в рамках третьего этапа научно-исследовательской работы по теме «Приложение методов доверенного и объяснимого искусственного интеллекта к анализу омикс-данных».

## Подготовка окружения

```bash
# clone project
cd <project directory>

# [OPTIONAL] create conda environment
conda create -n env_name python=3.9
conda activate env_name

# install pytorch according to instructions
# https://pytorch.org/get-started/

# install requirements
pip install -r requirements.txt
```

## Описание данных и экспериментов
Исследуются данные двух типов: эпигенетические и иммунологические данные.

### Эпигенетические данные
Данные метилирования ДНК цельной крови человека из репозитория [GEO](https://www.ncbi.nlm.nih.gov/geo/) со следующими условиями: крупнейшие наборы данных, которые включают как пациентов с болезнью Паркинсона, так и контрольную группу, при этом в каждой группе не менее 50 семплов.
Наборы данных GSE145361 и GSE111629 были выбраны в качестве тренировочно-валидационного набора данных, GSE72774 - в качестве тестового.
Всего 2968 семплов (2460 в тренировочно-валидационной выборке и 508 в тестовой).
Для построения моделей использовались 1000 наиболее важных признаков - CpG-сайтов.
Обученные в рамках второго этапа модели решают задачи классификации Cases (болезнь Паркинсона) vs Controls (здоровые) по данным отобранных признаков (CpG-сайтов).

### Иммунологические данные
Данные иммунологического профиля представляют из себя значения концентраций 10 наиболее значимых цитокинов в плазме крови для 300 человек (260 человек - тренировочно-валидационная выборка и 40 человек - тестовая).
Обученные в рамках второго этапа модели решают задачи регрессии хронологического возраста по данным иммунологии.


## Файловая структура
Директория `data` содержит данные согласно иерархии:
```
└── data                            <- Общая директория с данными
    ├── dnam                           <- Эпигенетические данные
    │   ├── model.ckpt                    <- Обученная в рамках второго этапа модель
    │   ├── models                        <- Результаты экспериментов
    │   ├── betas.xlsx                    <- Датасет
    │   ├── feats.xlsx                    <- Файл с указанием входных признаков
    │   └── classes.xlsx                  <- Файл с указанием классов
    └── immuno                         <- Иммунологические данные
        ├── model.ckpt                    <- Обученная в рамках второго этапа модель
        ├── models                        <- Результаты экспериментов
        ├── data.xlsx                     <- Датасет
        └── feats.xlsx                    <- Файл с указанием входных признаков
```

## Конфигурация экспериментов

### Расположение конфигурационных файлов

Конфигурационные файлы экспериментов находятся в следующих директориях:
```
└── configs
    └── experiment
        ├── dnam                              <- Эпигенетические данные
        │   └── classification
        │       ├── parkinson_trn_val_tst         <- Конфигурационный файл для построения моделей (прошлый, второй этап)
        │       └── parkinson_adverasarial        <- Конфигурационный файл для генерации атак, анализа области применимости и доверенности
        └── immuno                            <- Иммунологические данные
            └── regression
                ├── age_trn_val_tst               <- Конфигурационный файл для построения моделей (прошлый, второй этап)
                └── agw_adverasarial              <- Конфигурационный файл для генерации атак, анализа области применимости и доверенности
```

### Общая часть
Конфигурационные файлы `*_trn_val_tst` нужны для обучения и создания моделей машинного обучения, решающих задачи классификации и регрессии и были описаны в предыдущем этапе.

Конфигурационные файлы `*_adversarial` содержат следующие параметры для поиска состязательных примеров, анализа области применимости моделей в пространстве входных признаков и определения уверенности моделей при осуществении прогноза:
```yaml
attacks: True           # Флаг генерации состязательных атак
augmentations: True     # Флаг генерации аугментированных данных
aug_n_samples: 10000    # Количество сэмплов в сгененрированных аугментированных данных
outliers: True          # Флаг анализа аутлаеров
confidence: True        # Флаг анализа доверительных интервалов
```

## Запуск экспериментов

Для запуска эксперимента необходимо указать конфигурациионные файлы эксперимента `experiment` и модуля данных `datamodule` для конкретной задачи (классификация болезни Паркинсона по эпигенетическим данным или регрессия возраста по иммунологическим данным) а так же задать параметры эксперимента, описанные в разделе выше.

Пример запуска для поиска состязательных примеров, анализа области применимости моделей в пространстве входных признаков и определения уверенности моделей в задаче регрессии возраста:
```bash
python run_adversarial.py
-datamodule=configs/datamodule/immuno/regression/age
-experiment=configs/experiment/immuno/regression/age
-attacks=True
-augmentations=True 
-aug_n_samples=1000
-outliers=True
-confidence=True 
```

## Результаты
После запуска и окончания вычислений для выбранного эксперимента файлы и графики с результатами сохраняются в директории `models` выбранного эксперимента в соответствии с иерархией:

```
models
└── <модель>                  # Директория для выбранной модели
    └── runs                      # Директория с результатами единичных экспериментов
        ├── YYYY-MM-DD_HH-MM-SS       # Дата и время запуска
        │   ├── Augmentation                 # Директория с анализом аугментированных данных
        │   ├── Evasion                      # Директория с анализом атак
        │   └── ...                          # Результирующие файлы, графики
        └── ...
```
